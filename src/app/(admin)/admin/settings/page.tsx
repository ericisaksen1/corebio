import { prisma } from "@/lib/prisma"
import { auth } from "@/auth"
import { SettingsForm } from "./settings-form"

export const metadata = { title: "Settings" }

// Keys this form actually uses â€” only fetch these
const SETTINGS_FORM_KEYS = [
  "store_name", "store_description",
  "venmo_username", "venmo_qr_url",
  "cashapp_tag", "cashapp_qr_url",
  "bitcoin_address", "bitcoin_qr_url",
  "tax_rate", "shipping_flat_rate",
  "default_commission_rate", "affiliate_discount_rate",
  "parent_commission_rate", "affiliate_cookie_days",
  "low_stock_threshold",
  "enable_affiliates",
  "email_provider", "email_from_name", "email_from_address",
  "admin_notification_email",
]

// Sensitive keys only SUPER_ADMIN should see
const SENSITIVE_KEYS = [
  "shipstation_api_key", "shipstation_carrier_ids",
  "ship_from_name", "ship_from_street", "ship_from_city",
  "ship_from_state", "ship_from_zip", "ship_from_phone",
  "email_smtp_host", "email_smtp_port", "email_smtp_user", "email_smtp_password",
  "email_resend_api_key", "email_sendgrid_api_key",
  "entry_popup_enabled", "entry_popup_show_logo", "entry_popup_headline",
  "entry_popup_content", "entry_popup_agree_text", "entry_popup_disagree_text",
  "entry_popup_disagree_url", "entry_popup_persistence",
  "entry_popup_overlay_color", "entry_popup_overlay_opacity", "entry_popup_bg_color",
  "entry_popup_headline_color", "entry_popup_text_color",
  "entry_popup_agree_bg_color", "entry_popup_agree_text_color",
  "entry_popup_disagree_bg_color", "entry_popup_disagree_text_color",
  // Theme colors (read-only, for swatch pickers)
  "primary_color", "secondary_color", "accent_color",
  "foreground_color", "background_color", "muted_color", "border_color",
]

export default async function AdminSettingsPage() {
  const session = await auth()
  const isSuperAdmin = session?.user?.role === "SUPER_ADMIN"

  const allowedKeys = isSuperAdmin
    ? [...SETTINGS_FORM_KEYS, ...SENSITIVE_KEYS]
    : SETTINGS_FORM_KEYS

  const settings = await prisma.setting.findMany({
    where: { key: { in: allowedKeys } },
  })
  const settingsMap: Record<string, string> = {}
  for (const s of settings) {
    settingsMap[s.key] = s.value
  }

  return (
    <div className="max-w-2xl">
      <h1 className="text-2xl font-bold">Settings</h1>
      <p className="mt-1 text-sm text-gray-500">
        Configure your store settings and payment addresses.
      </p>

      <SettingsForm settings={settingsMap} isSuperAdmin={isSuperAdmin} />
    </div>
  )
}
